---
- name: Install Redis from redis.io
  hosts: all
  become: true
  vars:
    redis_bind_ip: "{{ redis_bind_ip }}"

  handlers:
    - name: restart redis
      service:
        name: redis-server
        state: restarted

  tasks:
    - name: Download Redis GPG key (ASCII format)
      get_url:
        url: https://packages.redis.io/gpg
        dest: /tmp/redis.gpg
        mode: '0644'

    - name: Convert Redis GPG key to binary and move to keyrings dir
      shell: |
        gpg --dearmor -o /etc/apt/keyrings/redis-archive-keyring.gpg /tmp/redis.gpg
      args:
        creates: /etc/apt/keyrings/redis-archive-keyring.gpg

    - name: Add Redis APT repository with signed-by
      apt_repository:
        repo: "deb [signed-by=/etc/apt/keyrings/redis-archive-keyring.gpg] https://packages.redis.io/deb {{ ansible_distribution_release | lower }} main"
        filename: redis
        state: present

    - name: Update APT cache
      apt:
        update_cache: yes

    - name: Install Redis
      apt:
        name: redis
        state: present

    - name: Configure Redis to bind only to the provided IP
      lineinfile:
        path: /etc/redis/redis.conf
        regexp: '^bind\s+.*'
        line: "bind 127.0.0.1 {{ redis_bind_ip }}"
        state: present
        backup: yes
      register: redis_bind

    - name: Ensure protected-mode is enabled
      lineinfile:
        path: /etc/redis/redis.conf
        regexp: '^protected-mode\s+.*'
        line: "protected-mode yes"
        state: present
      register: protected_mode

    - name: Restart Redis if config changed
      service:
        name: redis-server
        state: restarted
      when: redis_bind.changed or protected_mode.changed

    - name: Start and enable Redis
      service:
        name: redis-server
        state: started
        enabled: true

